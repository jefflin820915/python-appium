"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = void 0;

require("source-map-support/register");

var _lodash = _interopRequireDefault(require("lodash"));

var _fs2 = _interopRequireDefault(require("fs"));

var _teen_process = require("teen_process");

var _path = _interopRequireDefault(require("path"));

var _logger = _interopRequireDefault(require("../logger.js"));

var _appiumSupport = require("appium-support");

var _helpers = require("../helpers.js");

var _shellQuote = require("shell-quote");

const DEFAULT_PRIVATE_KEY = _path.default.resolve(_helpers.rootDir, 'keys', 'testkey.pk8');

const DEFAULT_CERTIFICATE = _path.default.resolve(_helpers.rootDir, 'keys', 'testkey.x509.pem');

const DEFAULT_CERT_DIGEST = 'a40da80a59d170caa950cf15c18c454d47a39b26989d8b640ecd745ba71bf5dc';
const BUNDLETOOL_TUTORIAL = 'https://developer.android.com/studio/command-line/bundletool';
const APKSIGNER_VERIFY_FAIL = 'DOES NOT VERIFY';
let apkSigningMethods = {};

apkSigningMethods.executeApksigner = async function executeApksigner(args = []) {
  const apkSignerJar = await (0, _helpers.getApksignerForOs)(this);
  const fullCmd = [await (0, _helpers.getJavaForOs)(), '-Xmx1024M', '-Xss1m', '-jar', apkSignerJar, ...args];

  _logger.default.debug(`Starting apksigner: ${(0, _shellQuote.quote)(fullCmd)}`);

  const {
    stdout,
    stderr
  } = await (0, _teen_process.exec)(fullCmd[0], fullCmd.slice(1));

  for (let [name, stream] of [['stdout', stdout], ['stderr', stderr]]) {
    if (!_lodash.default.trim(stream)) {
      continue;
    }

    if (name === 'stdout') {
      stream = stream.split('\n').filter(line => !line.includes('WARNING:')).join('\n');
    }

    _logger.default.debug(`apksigner ${name}: ${stream}`);
  }

  return stdout;
};

apkSigningMethods.signWithDefaultCert = async function signWithDefaultCert(apk) {
  _logger.default.debug(`Signing '${apk}' with default cert`);

  if (!(await _appiumSupport.fs.exists(apk))) {
    throw new Error(`${apk} file doesn't exist.`);
  }

  try {
    const args = ['sign', '--key', DEFAULT_PRIVATE_KEY, '--cert', DEFAULT_CERTIFICATE, apk];
    await this.executeApksigner(args);
  } catch (err) {
    _logger.default.warn(`Cannot use apksigner tool for signing. Defaulting to sign.jar. ` + `Original error: ${err.stderr || err.message}`);

    const signPath = _path.default.resolve(this.helperJarPath, 'sign.jar');

    const fullCmd = [await (0, _helpers.getJavaForOs)(), '-jar', signPath, apk, '--override'];

    _logger.default.debug(`Starting sign.jar: ${(0, _shellQuote.quote)(fullCmd)}`);

    try {
      await (0, _teen_process.exec)(fullCmd[0], fullCmd.slice(1));
    } catch (e) {
      throw new Error(`Could not sign with default certificate. ` + `Original error ${e.stderr || e.message}`);
    }
  }
};

apkSigningMethods.signWithCustomCert = async function signWithCustomCert(apk) {
  _logger.default.debug(`Signing '${apk}' with custom cert`);

  if (!(await _appiumSupport.fs.exists(this.keystorePath))) {
    throw new Error(`Keystore: ${this.keystorePath} doesn't exist.`);
  }

  if (!(await _appiumSupport.fs.exists(apk))) {
    throw new Error(`'${apk}' doesn't exist.`);
  }

  try {
    await this.executeApksigner(['sign', '--ks', this.keystorePath, '--ks-key-alias', this.keyAlias, '--ks-pass', `pass:${this.keystorePassword}`, '--key-pass', `pass:${this.keyPassword}`, apk]);
  } catch (err) {
    _logger.default.warn(`Cannot use apksigner tool for signing. Defaulting to jarsigner. ` + `Original error: ${err.stderr || err.message}`);

    try {
      if (await (0, _helpers.unsignApk)(apk)) {
        _logger.default.debug(`'${apk}' has been successfully unsigned`);
      } else {
        _logger.default.debug(`'${apk}' does not need to be unsigned`);
      }

      const jarsigner = _path.default.resolve((await (0, _helpers.getJavaHome)()), 'bin', `jarsigner${_appiumSupport.system.isWindows() ? '.exe' : ''}`);

      const fullCmd = [jarsigner, '-sigalg', 'MD5withRSA', '-digestalg', 'SHA1', '-keystore', this.keystorePath, '-storepass', this.keystorePassword, '-keypass', this.keyPassword, apk, this.keyAlias];

      _logger.default.debug(`Starting jarsigner: ${(0, _shellQuote.quote)(fullCmd)}`);

      await (0, _teen_process.exec)(fullCmd[0], fullCmd.slice(1));
    } catch (e) {
      throw new Error(`Could not sign with custom certificate. ` + `Original error: ${e.stderr || e.message}`);
    }
  }
};

apkSigningMethods.sign = async function sign(appPath) {
  if (appPath.endsWith(_helpers.APKS_EXTENSION)) {
    let message = 'Signing of .apks-files is not supported. ';

    if (this.useKeystore) {
      message += 'Consider manual application bundle signing with the custom keystore ' + `like it is described at ${BUNDLETOOL_TUTORIAL}`;
    } else {
      message += `Consider manual application bundle signing with the key at '${DEFAULT_PRIVATE_KEY}' ` + `and the certificate at '${DEFAULT_CERTIFICATE}'. Read ${BUNDLETOOL_TUTORIAL} for more details.`;
    }

    _logger.default.warn(message);

    return;
  }

  let apksignerFound = true;

  try {
    await (0, _helpers.getApksignerForOs)(this);
  } catch (err) {
    apksignerFound = false;
  }

  if (apksignerFound) {
    await this.zipAlignApk(appPath);
  }

  if (this.useKeystore) {
    await this.signWithCustomCert(appPath);
  } else {
    await this.signWithDefaultCert(appPath);
  }

  if (!apksignerFound) {
    await this.zipAlignApk(appPath);
  }
};

apkSigningMethods.zipAlignApk = async function zipAlignApk(apk) {
  await this.initZipAlign();

  try {
    await (0, _teen_process.exec)(this.binaries.zipalign, ['-c', '4', apk]);

    _logger.default.debug(`${apk}' is already zip-aligned. Doing nothing`);

    return false;
  } catch (e) {
    _logger.default.debug(`'${apk}' is not zip-aligned. Aligning`);
  }

  try {
    await _appiumSupport.fs.access(apk, _fs2.default.W_OK);
  } catch (e) {
    throw new Error(`The file at '${apk}' is not writeable. ` + `Please grant write permissions to this file or to its parent folder '${_path.default.dirname(apk)}' ` + `for the Appium process, so it can zip-align the file`);
  }

  const alignedApk = await _appiumSupport.tempDir.path({
    prefix: 'appium',
    suffix: '.tmp'
  });
  await (0, _appiumSupport.mkdirp)(_path.default.dirname(alignedApk));

  try {
    await (0, _teen_process.exec)(this.binaries.zipalign, ['-f', '4', apk, alignedApk]);
    await _appiumSupport.fs.mv(alignedApk, apk, {
      mkdirp: true
    });
    return true;
  } catch (e) {
    if (await _appiumSupport.fs.exists(alignedApk)) {
      await _appiumSupport.fs.unlink(alignedApk);
    }

    throw new Error(`zipAlignApk failed. Original error: ${e.stderr || e.message}`);
  }
};

apkSigningMethods.checkApkCert = async function checkApkCert(appPath, pkg, opts = {}) {
  _logger.default.debug(`Checking app cert for ${appPath}`);

  if (!(await _appiumSupport.fs.exists(appPath))) {
    _logger.default.debug(`'${appPath}' does not exist`);

    return false;
  }

  if (this.useKeystore) {
    return await this.checkCustomApkCert(appPath, pkg);
  }

  if (_path.default.extname(appPath) === _helpers.APKS_EXTENSION) {
    appPath = await this.extractBaseApk(appPath);
  }

  const {
    requireDefaultCert = true
  } = opts;

  try {
    await (0, _helpers.getApksignerForOs)(this);
    const output = await this.executeApksigner(['verify', '--print-certs', appPath]);

    if (_lodash.default.includes(output, DEFAULT_CERT_DIGEST)) {
      _logger.default.debug(`'${appPath}' is signed with the default certificate`);
    } else {
      _logger.default.debug(`'${appPath}' is signed with a non-default certificate`);
    }

    return !requireDefaultCert || _lodash.default.includes(output, DEFAULT_CERT_DIGEST);
  } catch (err) {
    if (_lodash.default.includes(err.stderr, APKSIGNER_VERIFY_FAIL)) {
      _logger.default.debug(`'${appPath}' is not signed`);

      return false;
    }

    _logger.default.warn(`Cannot use apksigner tool for signature verification. ` + `Original error: ${err.message}`);
  }

  _logger.default.debug(`Defaulting to verify.jar`);

  try {
    await (0, _teen_process.exec)((await (0, _helpers.getJavaForOs)()), ['-jar', _path.default.resolve(this.helperJarPath, 'verify.jar'), appPath]);

    _logger.default.debug(`'${appPath}' is signed with the default certificate`);

    return true;
  } catch (err) {
    if (!requireDefaultCert && _lodash.default.includes(_lodash.default.toLower(err.stderr), 'invalid cert')) {
      _logger.default.debug(`'${appPath}' is signed with a non-default certificate`);

      return true;
    }

    _logger.default.debug(`'${appPath}' is not signed with the default certificate`);

    _logger.default.debug(err.stderr ? err.stderr : err.message);

    return false;
  }
};

apkSigningMethods.checkCustomApkCert = async function checkCustomApkCert(appPath, pkg) {
  _logger.default.debug(`Checking custom app cert for ${appPath}`);

  if (_path.default.extname(appPath) === _helpers.APKS_EXTENSION) {
    appPath = await this.extractBaseApk(appPath);
  }

  let h = 'a-fA-F0-9';
  let md5Str = [`.*MD5.*((?:[${h}]{2}:){15}[${h}]{2})`];
  let md5 = new RegExp(md5Str, 'mi');

  let keytool = _path.default.resolve((await (0, _helpers.getJavaHome)()), 'bin', `keytool${_appiumSupport.system.isWindows() ? '.exe' : ''}`);

  let keystoreHash = await this.getKeystoreMd5(keytool, md5);
  return await this.checkApkKeystoreMatch(keytool, md5, keystoreHash, pkg, appPath);
};

apkSigningMethods.getKeystoreMd5 = async function getKeystoreMd5(keytool, md5re) {
  _logger.default.debug('Printing keystore md5.');

  try {
    let {
      stdout
    } = await (0, _teen_process.exec)(keytool, ['-v', '-list', '-alias', this.keyAlias, '-keystore', this.keystorePath, '-storepass', this.keystorePassword]);
    let keystoreHash = md5re.exec(stdout);
    keystoreHash = keystoreHash ? keystoreHash[1] : null;

    _logger.default.debug(`Keystore MD5: ${keystoreHash}`);

    return keystoreHash;
  } catch (e) {
    throw new Error(`getKeystoreMd5 failed. Original error: ${e.message}`);
  }
};

apkSigningMethods.checkApkKeystoreMatch = async function checkApkKeystoreMatch(keytool, md5re, keystoreHash, pkg, apk) {
  let entryHash = null;
  let rsa = /^META-INF\/.*\.[rR][sS][aA]$/;
  let foundKeystoreMatch = false;
  await _appiumSupport.zip.readEntries(apk, async ({
    entry,
    extractEntryTo
  }) => {
    entry = entry.fileName;

    if (!rsa.test(entry)) {
      return;
    }

    _logger.default.debug(`Entry: ${entry}`);

    let entryPath = _path.default.join(this.tmpDir, pkg, 'cert');

    _logger.default.debug(`entryPath: ${entryPath}`);

    let entryFile = _path.default.join(entryPath, entry);

    _logger.default.debug(`entryFile: ${entryFile}`);

    await _appiumSupport.fs.rimraf(entryPath);
    await extractEntryTo(entryPath);

    _logger.default.debug('extracted!');

    _logger.default.debug('Printing apk md5.');

    let {
      stdout
    } = await (0, _teen_process.exec)(keytool, ['-v', '-printcert', '-file', entryFile]);
    entryHash = md5re.exec(stdout);
    entryHash = entryHash ? entryHash[1] : null;

    _logger.default.debug(`entryHash MD5: ${entryHash}`);

    _logger.default.debug(`keystore MD5: ${keystoreHash}`);

    let matchesKeystore = entryHash && entryHash === keystoreHash;

    _logger.default.debug(`Matches keystore? ${matchesKeystore}`);

    if (matchesKeystore) {
      foundKeystoreMatch = true;
      return false;
    }
  });
  return foundKeystoreMatch;
};

var _default = apkSigningMethods;
exports.default = _default;require('source-map-support').install();


//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImxpYi90b29scy9hcGstc2lnbmluZy5qcyJdLCJuYW1lcyI6WyJERUZBVUxUX1BSSVZBVEVfS0VZIiwicGF0aCIsInJlc29sdmUiLCJyb290RGlyIiwiREVGQVVMVF9DRVJUSUZJQ0FURSIsIkRFRkFVTFRfQ0VSVF9ESUdFU1QiLCJCVU5ETEVUT09MX1RVVE9SSUFMIiwiQVBLU0lHTkVSX1ZFUklGWV9GQUlMIiwiYXBrU2lnbmluZ01ldGhvZHMiLCJleGVjdXRlQXBrc2lnbmVyIiwiYXJncyIsImFwa1NpZ25lckphciIsImZ1bGxDbWQiLCJsb2ciLCJkZWJ1ZyIsInN0ZG91dCIsInN0ZGVyciIsInNsaWNlIiwibmFtZSIsInN0cmVhbSIsIl8iLCJ0cmltIiwic3BsaXQiLCJmaWx0ZXIiLCJsaW5lIiwiaW5jbHVkZXMiLCJqb2luIiwic2lnbldpdGhEZWZhdWx0Q2VydCIsImFwayIsImZzIiwiZXhpc3RzIiwiRXJyb3IiLCJlcnIiLCJ3YXJuIiwibWVzc2FnZSIsInNpZ25QYXRoIiwiaGVscGVySmFyUGF0aCIsImUiLCJzaWduV2l0aEN1c3RvbUNlcnQiLCJrZXlzdG9yZVBhdGgiLCJrZXlBbGlhcyIsImtleXN0b3JlUGFzc3dvcmQiLCJrZXlQYXNzd29yZCIsImphcnNpZ25lciIsInN5c3RlbSIsImlzV2luZG93cyIsInNpZ24iLCJhcHBQYXRoIiwiZW5kc1dpdGgiLCJBUEtTX0VYVEVOU0lPTiIsInVzZUtleXN0b3JlIiwiYXBrc2lnbmVyRm91bmQiLCJ6aXBBbGlnbkFwayIsImluaXRaaXBBbGlnbiIsImJpbmFyaWVzIiwiemlwYWxpZ24iLCJhY2Nlc3MiLCJfZnMiLCJXX09LIiwiZGlybmFtZSIsImFsaWduZWRBcGsiLCJ0ZW1wRGlyIiwicHJlZml4Iiwic3VmZml4IiwibXYiLCJta2RpcnAiLCJ1bmxpbmsiLCJjaGVja0Fwa0NlcnQiLCJwa2ciLCJvcHRzIiwiY2hlY2tDdXN0b21BcGtDZXJ0IiwiZXh0bmFtZSIsImV4dHJhY3RCYXNlQXBrIiwicmVxdWlyZURlZmF1bHRDZXJ0Iiwib3V0cHV0IiwidG9Mb3dlciIsImgiLCJtZDVTdHIiLCJtZDUiLCJSZWdFeHAiLCJrZXl0b29sIiwia2V5c3RvcmVIYXNoIiwiZ2V0S2V5c3RvcmVNZDUiLCJjaGVja0Fwa0tleXN0b3JlTWF0Y2giLCJtZDVyZSIsImV4ZWMiLCJlbnRyeUhhc2giLCJyc2EiLCJmb3VuZEtleXN0b3JlTWF0Y2giLCJ6aXAiLCJyZWFkRW50cmllcyIsImVudHJ5IiwiZXh0cmFjdEVudHJ5VG8iLCJmaWxlTmFtZSIsInRlc3QiLCJlbnRyeVBhdGgiLCJ0bXBEaXIiLCJlbnRyeUZpbGUiLCJyaW1yYWYiLCJtYXRjaGVzS2V5c3RvcmUiXSwibWFwcGluZ3MiOiI7Ozs7Ozs7Ozs7O0FBQUE7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBSUE7O0FBRUEsTUFBTUEsbUJBQW1CLEdBQUdDLGNBQUtDLE9BQUwsQ0FBYUMsZ0JBQWIsRUFBc0IsTUFBdEIsRUFBOEIsYUFBOUIsQ0FBNUI7O0FBQ0EsTUFBTUMsbUJBQW1CLEdBQUdILGNBQUtDLE9BQUwsQ0FBYUMsZ0JBQWIsRUFBc0IsTUFBdEIsRUFBOEIsa0JBQTlCLENBQTVCOztBQUNBLE1BQU1FLG1CQUFtQixHQUFHLGtFQUE1QjtBQUNBLE1BQU1DLG1CQUFtQixHQUFHLDhEQUE1QjtBQUNBLE1BQU1DLHFCQUFxQixHQUFHLGlCQUE5QjtBQUVBLElBQUlDLGlCQUFpQixHQUFHLEVBQXhCOztBQVVBQSxpQkFBaUIsQ0FBQ0MsZ0JBQWxCLEdBQXFDLGVBQWVBLGdCQUFmLENBQWlDQyxJQUFJLEdBQUcsRUFBeEMsRUFBNEM7QUFDL0UsUUFBTUMsWUFBWSxHQUFHLE1BQU0sZ0NBQWtCLElBQWxCLENBQTNCO0FBQ0EsUUFBTUMsT0FBTyxHQUFHLENBQ2QsTUFBTSw0QkFEUSxFQUNRLFdBRFIsRUFDcUIsUUFEckIsRUFFZCxNQUZjLEVBRU5ELFlBRk0sRUFHZCxHQUFHRCxJQUhXLENBQWhCOztBQUtBRyxrQkFBSUMsS0FBSixDQUFXLHVCQUFzQix1QkFBTUYsT0FBTixDQUFlLEVBQWhEOztBQUNBLFFBQU07QUFBQ0csSUFBQUEsTUFBRDtBQUFTQyxJQUFBQTtBQUFULE1BQW1CLE1BQU0sd0JBQUtKLE9BQU8sQ0FBQyxDQUFELENBQVosRUFBaUJBLE9BQU8sQ0FBQ0ssS0FBUixDQUFjLENBQWQsQ0FBakIsQ0FBL0I7O0FBQ0EsT0FBSyxJQUFJLENBQUNDLElBQUQsRUFBT0MsTUFBUCxDQUFULElBQTJCLENBQUMsQ0FBQyxRQUFELEVBQVdKLE1BQVgsQ0FBRCxFQUFxQixDQUFDLFFBQUQsRUFBV0MsTUFBWCxDQUFyQixDQUEzQixFQUFxRTtBQUNuRSxRQUFJLENBQUNJLGdCQUFFQyxJQUFGLENBQU9GLE1BQVAsQ0FBTCxFQUFxQjtBQUNuQjtBQUNEOztBQUVELFFBQUlELElBQUksS0FBSyxRQUFiLEVBQXVCO0FBRXJCQyxNQUFBQSxNQUFNLEdBQUdBLE1BQU0sQ0FBQ0csS0FBUCxDQUFhLElBQWIsRUFDTkMsTUFETSxDQUNFQyxJQUFELElBQVUsQ0FBQ0EsSUFBSSxDQUFDQyxRQUFMLENBQWMsVUFBZCxDQURaLEVBRU5DLElBRk0sQ0FFRCxJQUZDLENBQVQ7QUFHRDs7QUFDRGIsb0JBQUlDLEtBQUosQ0FBVyxhQUFZSSxJQUFLLEtBQUlDLE1BQU8sRUFBdkM7QUFDRDs7QUFDRCxTQUFPSixNQUFQO0FBQ0QsQ0F2QkQ7O0FBK0JBUCxpQkFBaUIsQ0FBQ21CLG1CQUFsQixHQUF3QyxlQUFlQSxtQkFBZixDQUFvQ0MsR0FBcEMsRUFBeUM7QUFDL0VmLGtCQUFJQyxLQUFKLENBQVcsWUFBV2MsR0FBSSxxQkFBMUI7O0FBQ0EsTUFBSSxFQUFFLE1BQU1DLGtCQUFHQyxNQUFILENBQVVGLEdBQVYsQ0FBUixDQUFKLEVBQTZCO0FBQzNCLFVBQU0sSUFBSUcsS0FBSixDQUFXLEdBQUVILEdBQUksc0JBQWpCLENBQU47QUFDRDs7QUFFRCxNQUFJO0FBQ0YsVUFBTWxCLElBQUksR0FBRyxDQUFDLE1BQUQsRUFDWCxPQURXLEVBQ0ZWLG1CQURFLEVBRVgsUUFGVyxFQUVESSxtQkFGQyxFQUdYd0IsR0FIVyxDQUFiO0FBSUEsVUFBTSxLQUFLbkIsZ0JBQUwsQ0FBc0JDLElBQXRCLENBQU47QUFDRCxHQU5ELENBTUUsT0FBT3NCLEdBQVAsRUFBWTtBQUNabkIsb0JBQUlvQixJQUFKLENBQVUsaUVBQUQsR0FDTixtQkFBa0JELEdBQUcsQ0FBQ2hCLE1BQUosSUFBY2dCLEdBQUcsQ0FBQ0UsT0FBUSxFQUQvQzs7QUFFQSxVQUFNQyxRQUFRLEdBQUdsQyxjQUFLQyxPQUFMLENBQWEsS0FBS2tDLGFBQWxCLEVBQWlDLFVBQWpDLENBQWpCOztBQUNBLFVBQU14QixPQUFPLEdBQUcsQ0FBQyxNQUFNLDRCQUFQLEVBQXVCLE1BQXZCLEVBQStCdUIsUUFBL0IsRUFBeUNQLEdBQXpDLEVBQThDLFlBQTlDLENBQWhCOztBQUNBZixvQkFBSUMsS0FBSixDQUFXLHNCQUFxQix1QkFBTUYsT0FBTixDQUFlLEVBQS9DOztBQUNBLFFBQUk7QUFDRixZQUFNLHdCQUFLQSxPQUFPLENBQUMsQ0FBRCxDQUFaLEVBQWlCQSxPQUFPLENBQUNLLEtBQVIsQ0FBYyxDQUFkLENBQWpCLENBQU47QUFDRCxLQUZELENBRUUsT0FBT29CLENBQVAsRUFBVTtBQUNWLFlBQU0sSUFBSU4sS0FBSixDQUFXLDJDQUFELEdBQ2Isa0JBQWlCTSxDQUFDLENBQUNyQixNQUFGLElBQVlxQixDQUFDLENBQUNILE9BQVEsRUFEcEMsQ0FBTjtBQUVEO0FBQ0Y7QUFDRixDQXpCRDs7QUFpQ0ExQixpQkFBaUIsQ0FBQzhCLGtCQUFsQixHQUF1QyxlQUFlQSxrQkFBZixDQUFtQ1YsR0FBbkMsRUFBd0M7QUFDN0VmLGtCQUFJQyxLQUFKLENBQVcsWUFBV2MsR0FBSSxvQkFBMUI7O0FBQ0EsTUFBSSxFQUFFLE1BQU1DLGtCQUFHQyxNQUFILENBQVUsS0FBS1MsWUFBZixDQUFSLENBQUosRUFBMkM7QUFDekMsVUFBTSxJQUFJUixLQUFKLENBQVcsYUFBWSxLQUFLUSxZQUFhLGlCQUF6QyxDQUFOO0FBQ0Q7O0FBQ0QsTUFBSSxFQUFFLE1BQU1WLGtCQUFHQyxNQUFILENBQVVGLEdBQVYsQ0FBUixDQUFKLEVBQTZCO0FBQzNCLFVBQU0sSUFBSUcsS0FBSixDQUFXLElBQUdILEdBQUksa0JBQWxCLENBQU47QUFDRDs7QUFFRCxNQUFJO0FBQ0YsVUFBTSxLQUFLbkIsZ0JBQUwsQ0FBc0IsQ0FBQyxNQUFELEVBQzFCLE1BRDBCLEVBQ2xCLEtBQUs4QixZQURhLEVBRTFCLGdCQUYwQixFQUVSLEtBQUtDLFFBRkcsRUFHMUIsV0FIMEIsRUFHWixRQUFPLEtBQUtDLGdCQUFpQixFQUhqQixFQUkxQixZQUowQixFQUlYLFFBQU8sS0FBS0MsV0FBWSxFQUpiLEVBSzFCZCxHQUwwQixDQUF0QixDQUFOO0FBTUQsR0FQRCxDQU9FLE9BQU9JLEdBQVAsRUFBWTtBQUNabkIsb0JBQUlvQixJQUFKLENBQVUsa0VBQUQsR0FDTixtQkFBa0JELEdBQUcsQ0FBQ2hCLE1BQUosSUFBY2dCLEdBQUcsQ0FBQ0UsT0FBUSxFQUQvQzs7QUFFQSxRQUFJO0FBQ0YsVUFBSSxNQUFNLHdCQUFVTixHQUFWLENBQVYsRUFBMEI7QUFDeEJmLHdCQUFJQyxLQUFKLENBQVcsSUFBR2MsR0FBSSxrQ0FBbEI7QUFDRCxPQUZELE1BRU87QUFDTGYsd0JBQUlDLEtBQUosQ0FBVyxJQUFHYyxHQUFJLGdDQUFsQjtBQUNEOztBQUNELFlBQU1lLFNBQVMsR0FBRzFDLGNBQUtDLE9BQUwsRUFBYSxNQUFNLDJCQUFuQixHQUFrQyxLQUFsQyxFQUNmLFlBQVcwQyxzQkFBT0MsU0FBUCxLQUFxQixNQUFyQixHQUE4QixFQUFHLEVBRDdCLENBQWxCOztBQUVBLFlBQU1qQyxPQUFPLEdBQUcsQ0FBQytCLFNBQUQsRUFDZCxTQURjLEVBQ0gsWUFERyxFQUVkLFlBRmMsRUFFQSxNQUZBLEVBR2QsV0FIYyxFQUdELEtBQUtKLFlBSEosRUFJZCxZQUpjLEVBSUEsS0FBS0UsZ0JBSkwsRUFLZCxVQUxjLEVBS0YsS0FBS0MsV0FMSCxFQU1kZCxHQU5jLEVBTVQsS0FBS1ksUUFOSSxDQUFoQjs7QUFPQTNCLHNCQUFJQyxLQUFKLENBQVcsdUJBQXNCLHVCQUFNRixPQUFOLENBQWUsRUFBaEQ7O0FBQ0EsWUFBTSx3QkFBS0EsT0FBTyxDQUFDLENBQUQsQ0FBWixFQUFpQkEsT0FBTyxDQUFDSyxLQUFSLENBQWMsQ0FBZCxDQUFqQixDQUFOO0FBQ0QsS0FqQkQsQ0FpQkUsT0FBT29CLENBQVAsRUFBVTtBQUNWLFlBQU0sSUFBSU4sS0FBSixDQUFXLDBDQUFELEdBQ2IsbUJBQWtCTSxDQUFDLENBQUNyQixNQUFGLElBQVlxQixDQUFDLENBQUNILE9BQVEsRUFEckMsQ0FBTjtBQUVEO0FBQ0Y7QUFDRixDQXpDRDs7QUFtREExQixpQkFBaUIsQ0FBQ3NDLElBQWxCLEdBQXlCLGVBQWVBLElBQWYsQ0FBcUJDLE9BQXJCLEVBQThCO0FBQ3JELE1BQUlBLE9BQU8sQ0FBQ0MsUUFBUixDQUFpQkMsdUJBQWpCLENBQUosRUFBc0M7QUFDcEMsUUFBSWYsT0FBTyxHQUFHLDJDQUFkOztBQUNBLFFBQUksS0FBS2dCLFdBQVQsRUFBc0I7QUFDcEJoQixNQUFBQSxPQUFPLElBQUkseUVBQ1IsMkJBQTBCNUIsbUJBQW9CLEVBRGpEO0FBRUQsS0FIRCxNQUdPO0FBQ0w0QixNQUFBQSxPQUFPLElBQUssK0RBQThEbEMsbUJBQW9CLElBQW5GLEdBQ1IsMkJBQTBCSSxtQkFBb0IsV0FBVUUsbUJBQW9CLG9CQUQvRTtBQUVEOztBQUNETyxvQkFBSW9CLElBQUosQ0FBU0MsT0FBVDs7QUFDQTtBQUNEOztBQUVELE1BQUlpQixjQUFjLEdBQUcsSUFBckI7O0FBQ0EsTUFBSTtBQUNGLFVBQU0sZ0NBQWtCLElBQWxCLENBQU47QUFDRCxHQUZELENBRUUsT0FBT25CLEdBQVAsRUFBWTtBQUNabUIsSUFBQUEsY0FBYyxHQUFHLEtBQWpCO0FBQ0Q7O0FBRUQsTUFBSUEsY0FBSixFQUFvQjtBQUlsQixVQUFNLEtBQUtDLFdBQUwsQ0FBaUJMLE9BQWpCLENBQU47QUFDRDs7QUFFRCxNQUFJLEtBQUtHLFdBQVQsRUFBc0I7QUFDcEIsVUFBTSxLQUFLWixrQkFBTCxDQUF3QlMsT0FBeEIsQ0FBTjtBQUNELEdBRkQsTUFFTztBQUNMLFVBQU0sS0FBS3BCLG1CQUFMLENBQXlCb0IsT0FBekIsQ0FBTjtBQUNEOztBQUVELE1BQUksQ0FBQ0ksY0FBTCxFQUFxQjtBQUNuQixVQUFNLEtBQUtDLFdBQUwsQ0FBaUJMLE9BQWpCLENBQU47QUFDRDtBQUNGLENBckNEOztBQStDQXZDLGlCQUFpQixDQUFDNEMsV0FBbEIsR0FBZ0MsZUFBZUEsV0FBZixDQUE0QnhCLEdBQTVCLEVBQWlDO0FBQy9ELFFBQU0sS0FBS3lCLFlBQUwsRUFBTjs7QUFDQSxNQUFJO0FBQ0YsVUFBTSx3QkFBSyxLQUFLQyxRQUFMLENBQWNDLFFBQW5CLEVBQTZCLENBQUMsSUFBRCxFQUFPLEdBQVAsRUFBWTNCLEdBQVosQ0FBN0IsQ0FBTjs7QUFDQWYsb0JBQUlDLEtBQUosQ0FBVyxHQUFFYyxHQUFJLHlDQUFqQjs7QUFDQSxXQUFPLEtBQVA7QUFDRCxHQUpELENBSUUsT0FBT1MsQ0FBUCxFQUFVO0FBQ1Z4QixvQkFBSUMsS0FBSixDQUFXLElBQUdjLEdBQUksZ0NBQWxCO0FBQ0Q7O0FBQ0QsTUFBSTtBQUNGLFVBQU1DLGtCQUFHMkIsTUFBSCxDQUFVNUIsR0FBVixFQUFlNkIsYUFBSUMsSUFBbkIsQ0FBTjtBQUNELEdBRkQsQ0FFRSxPQUFPckIsQ0FBUCxFQUFVO0FBQ1YsVUFBTSxJQUFJTixLQUFKLENBQVcsZ0JBQWVILEdBQUksc0JBQXBCLEdBQ2Isd0VBQXVFM0IsY0FBSzBELE9BQUwsQ0FBYS9CLEdBQWIsQ0FBa0IsSUFENUUsR0FFYixzREFGRyxDQUFOO0FBR0Q7O0FBQ0QsUUFBTWdDLFVBQVUsR0FBRyxNQUFNQyx1QkFBUTVELElBQVIsQ0FBYTtBQUFDNkQsSUFBQUEsTUFBTSxFQUFFLFFBQVQ7QUFBbUJDLElBQUFBLE1BQU0sRUFBRTtBQUEzQixHQUFiLENBQXpCO0FBQ0EsUUFBTSwyQkFBTzlELGNBQUswRCxPQUFMLENBQWFDLFVBQWIsQ0FBUCxDQUFOOztBQUNBLE1BQUk7QUFDRixVQUFNLHdCQUFLLEtBQUtOLFFBQUwsQ0FBY0MsUUFBbkIsRUFBNkIsQ0FBQyxJQUFELEVBQU8sR0FBUCxFQUFZM0IsR0FBWixFQUFpQmdDLFVBQWpCLENBQTdCLENBQU47QUFDQSxVQUFNL0Isa0JBQUdtQyxFQUFILENBQU1KLFVBQU4sRUFBa0JoQyxHQUFsQixFQUF1QjtBQUFFcUMsTUFBQUEsTUFBTSxFQUFFO0FBQVYsS0FBdkIsQ0FBTjtBQUNBLFdBQU8sSUFBUDtBQUNELEdBSkQsQ0FJRSxPQUFPNUIsQ0FBUCxFQUFVO0FBQ1YsUUFBSSxNQUFNUixrQkFBR0MsTUFBSCxDQUFVOEIsVUFBVixDQUFWLEVBQWlDO0FBQy9CLFlBQU0vQixrQkFBR3FDLE1BQUgsQ0FBVU4sVUFBVixDQUFOO0FBQ0Q7O0FBQ0QsVUFBTSxJQUFJN0IsS0FBSixDQUFXLHVDQUFzQ00sQ0FBQyxDQUFDckIsTUFBRixJQUFZcUIsQ0FBQyxDQUFDSCxPQUFRLEVBQXZFLENBQU47QUFDRDtBQUNGLENBNUJEOztBQTZDQTFCLGlCQUFpQixDQUFDMkQsWUFBbEIsR0FBaUMsZUFBZUEsWUFBZixDQUE2QnBCLE9BQTdCLEVBQXNDcUIsR0FBdEMsRUFBMkNDLElBQUksR0FBRyxFQUFsRCxFQUFzRDtBQUNyRnhELGtCQUFJQyxLQUFKLENBQVcseUJBQXdCaUMsT0FBUSxFQUEzQzs7QUFDQSxNQUFJLEVBQUMsTUFBTWxCLGtCQUFHQyxNQUFILENBQVVpQixPQUFWLENBQVAsQ0FBSixFQUErQjtBQUM3QmxDLG9CQUFJQyxLQUFKLENBQVcsSUFBR2lDLE9BQVEsa0JBQXRCOztBQUNBLFdBQU8sS0FBUDtBQUNEOztBQUVELE1BQUksS0FBS0csV0FBVCxFQUFzQjtBQUNwQixXQUFPLE1BQU0sS0FBS29CLGtCQUFMLENBQXdCdkIsT0FBeEIsRUFBaUNxQixHQUFqQyxDQUFiO0FBQ0Q7O0FBRUQsTUFBSW5FLGNBQUtzRSxPQUFMLENBQWF4QixPQUFiLE1BQTBCRSx1QkFBOUIsRUFBOEM7QUFDNUNGLElBQUFBLE9BQU8sR0FBRyxNQUFNLEtBQUt5QixjQUFMLENBQW9CekIsT0FBcEIsQ0FBaEI7QUFDRDs7QUFFRCxRQUFNO0FBQ0owQixJQUFBQSxrQkFBa0IsR0FBRztBQURqQixNQUVGSixJQUZKOztBQUdBLE1BQUk7QUFDRixVQUFNLGdDQUFrQixJQUFsQixDQUFOO0FBQ0EsVUFBTUssTUFBTSxHQUFHLE1BQU0sS0FBS2pFLGdCQUFMLENBQXNCLENBQUMsUUFBRCxFQUFXLGVBQVgsRUFBNEJzQyxPQUE1QixDQUF0QixDQUFyQjs7QUFDQSxRQUFJM0IsZ0JBQUVLLFFBQUYsQ0FBV2lELE1BQVgsRUFBbUJyRSxtQkFBbkIsQ0FBSixFQUE2QztBQUMzQ1Esc0JBQUlDLEtBQUosQ0FBVyxJQUFHaUMsT0FBUSwwQ0FBdEI7QUFDRCxLQUZELE1BRU87QUFDTGxDLHNCQUFJQyxLQUFKLENBQVcsSUFBR2lDLE9BQVEsNENBQXRCO0FBQ0Q7O0FBQ0QsV0FBTyxDQUFDMEIsa0JBQUQsSUFBdUJyRCxnQkFBRUssUUFBRixDQUFXaUQsTUFBWCxFQUFtQnJFLG1CQUFuQixDQUE5QjtBQUNELEdBVEQsQ0FTRSxPQUFPMkIsR0FBUCxFQUFZO0FBRVosUUFBSVosZ0JBQUVLLFFBQUYsQ0FBV08sR0FBRyxDQUFDaEIsTUFBZixFQUF1QlQscUJBQXZCLENBQUosRUFBbUQ7QUFDakRNLHNCQUFJQyxLQUFKLENBQVcsSUFBR2lDLE9BQVEsaUJBQXRCOztBQUNBLGFBQU8sS0FBUDtBQUNEOztBQUNEbEMsb0JBQUlvQixJQUFKLENBQVUsd0RBQUQsR0FDTixtQkFBa0JELEdBQUcsQ0FBQ0UsT0FBUSxFQURqQztBQUVEOztBQUVEckIsa0JBQUlDLEtBQUosQ0FBVywwQkFBWDs7QUFDQSxNQUFJO0FBQ0YsVUFBTSx5QkFBSyxNQUFNLDRCQUFYLEdBQTJCLENBQy9CLE1BRCtCLEVBQ3ZCYixjQUFLQyxPQUFMLENBQWEsS0FBS2tDLGFBQWxCLEVBQWlDLFlBQWpDLENBRHVCLEVBRS9CVyxPQUYrQixDQUEzQixDQUFOOztBQUlBbEMsb0JBQUlDLEtBQUosQ0FBVyxJQUFHaUMsT0FBUSwwQ0FBdEI7O0FBQ0EsV0FBTyxJQUFQO0FBQ0QsR0FQRCxDQU9FLE9BQU9mLEdBQVAsRUFBWTtBQUNaLFFBQUksQ0FBQ3lDLGtCQUFELElBQXVCckQsZ0JBQUVLLFFBQUYsQ0FBV0wsZ0JBQUV1RCxPQUFGLENBQVUzQyxHQUFHLENBQUNoQixNQUFkLENBQVgsRUFBa0MsY0FBbEMsQ0FBM0IsRUFBOEU7QUFDNUVILHNCQUFJQyxLQUFKLENBQVcsSUFBR2lDLE9BQVEsNENBQXRCOztBQUNBLGFBQU8sSUFBUDtBQUNEOztBQUNEbEMsb0JBQUlDLEtBQUosQ0FBVyxJQUFHaUMsT0FBUSw4Q0FBdEI7O0FBQ0FsQyxvQkFBSUMsS0FBSixDQUFVa0IsR0FBRyxDQUFDaEIsTUFBSixHQUFhZ0IsR0FBRyxDQUFDaEIsTUFBakIsR0FBMEJnQixHQUFHLENBQUNFLE9BQXhDOztBQUNBLFdBQU8sS0FBUDtBQUNEO0FBQ0YsQ0F0REQ7O0FBK0RBMUIsaUJBQWlCLENBQUM4RCxrQkFBbEIsR0FBdUMsZUFBZUEsa0JBQWYsQ0FBbUN2QixPQUFuQyxFQUE0Q3FCLEdBQTVDLEVBQWlEO0FBQ3RGdkQsa0JBQUlDLEtBQUosQ0FBVyxnQ0FBK0JpQyxPQUFRLEVBQWxEOztBQUVBLE1BQUk5QyxjQUFLc0UsT0FBTCxDQUFheEIsT0FBYixNQUEwQkUsdUJBQTlCLEVBQThDO0FBQzVDRixJQUFBQSxPQUFPLEdBQUcsTUFBTSxLQUFLeUIsY0FBTCxDQUFvQnpCLE9BQXBCLENBQWhCO0FBQ0Q7O0FBRUQsTUFBSTZCLENBQUMsR0FBRyxXQUFSO0FBQ0EsTUFBSUMsTUFBTSxHQUFHLENBQUUsZUFBY0QsQ0FBRSxjQUFhQSxDQUFFLE9BQWpDLENBQWI7QUFDQSxNQUFJRSxHQUFHLEdBQUcsSUFBSUMsTUFBSixDQUFXRixNQUFYLEVBQW1CLElBQW5CLENBQVY7O0FBQ0EsTUFBSUcsT0FBTyxHQUFHL0UsY0FBS0MsT0FBTCxFQUFhLE1BQU0sMkJBQW5CLEdBQWtDLEtBQWxDLEVBQ1gsVUFBUzBDLHNCQUFPQyxTQUFQLEtBQXFCLE1BQXJCLEdBQThCLEVBQUcsRUFEL0IsQ0FBZDs7QUFFQSxNQUFJb0MsWUFBWSxHQUFHLE1BQU0sS0FBS0MsY0FBTCxDQUFvQkYsT0FBcEIsRUFBNkJGLEdBQTdCLENBQXpCO0FBQ0EsU0FBTyxNQUFNLEtBQUtLLHFCQUFMLENBQTJCSCxPQUEzQixFQUFvQ0YsR0FBcEMsRUFBeUNHLFlBQXpDLEVBQXVEYixHQUF2RCxFQUE0RHJCLE9BQTVELENBQWI7QUFDRCxDQWREOztBQXdCQXZDLGlCQUFpQixDQUFDMEUsY0FBbEIsR0FBbUMsZUFBZUEsY0FBZixDQUErQkYsT0FBL0IsRUFBd0NJLEtBQXhDLEVBQStDO0FBQ2hGdkUsa0JBQUlDLEtBQUosQ0FBVSx3QkFBVjs7QUFDQSxNQUFJO0FBQ0YsUUFBSTtBQUFDQyxNQUFBQTtBQUFELFFBQVcsTUFBTSx3QkFBS2lFLE9BQUwsRUFBYyxDQUFDLElBQUQsRUFBTyxPQUFQLEVBQ2pDLFFBRGlDLEVBQ3ZCLEtBQUt4QyxRQURrQixFQUVqQyxXQUZpQyxFQUVwQixLQUFLRCxZQUZlLEVBR2pDLFlBSGlDLEVBR25CLEtBQUtFLGdCQUhjLENBQWQsQ0FBckI7QUFJQSxRQUFJd0MsWUFBWSxHQUFHRyxLQUFLLENBQUNDLElBQU4sQ0FBV3RFLE1BQVgsQ0FBbkI7QUFDQWtFLElBQUFBLFlBQVksR0FBR0EsWUFBWSxHQUFHQSxZQUFZLENBQUMsQ0FBRCxDQUFmLEdBQXFCLElBQWhEOztBQUNBcEUsb0JBQUlDLEtBQUosQ0FBVyxpQkFBZ0JtRSxZQUFhLEVBQXhDOztBQUNBLFdBQU9BLFlBQVA7QUFDRCxHQVRELENBU0UsT0FBTzVDLENBQVAsRUFBVTtBQUNWLFVBQU0sSUFBSU4sS0FBSixDQUFXLDBDQUF5Q00sQ0FBQyxDQUFDSCxPQUFRLEVBQTlELENBQU47QUFDRDtBQUNGLENBZEQ7O0FBMkJBMUIsaUJBQWlCLENBQUMyRSxxQkFBbEIsR0FBMEMsZUFBZUEscUJBQWYsQ0FBc0NILE9BQXRDLEVBQStDSSxLQUEvQyxFQUFzREgsWUFBdEQsRUFBb0ViLEdBQXBFLEVBQXlFeEMsR0FBekUsRUFBOEU7QUFDdEgsTUFBSTBELFNBQVMsR0FBRyxJQUFoQjtBQUNBLE1BQUlDLEdBQUcsR0FBRyw4QkFBVjtBQUNBLE1BQUlDLGtCQUFrQixHQUFHLEtBQXpCO0FBR0EsUUFBTUMsbUJBQUlDLFdBQUosQ0FBZ0I5RCxHQUFoQixFQUFxQixPQUFPO0FBQUMrRCxJQUFBQSxLQUFEO0FBQVFDLElBQUFBO0FBQVIsR0FBUCxLQUFtQztBQUM1REQsSUFBQUEsS0FBSyxHQUFHQSxLQUFLLENBQUNFLFFBQWQ7O0FBQ0EsUUFBSSxDQUFDTixHQUFHLENBQUNPLElBQUosQ0FBU0gsS0FBVCxDQUFMLEVBQXNCO0FBQ3BCO0FBQ0Q7O0FBQ0Q5RSxvQkFBSUMsS0FBSixDQUFXLFVBQVM2RSxLQUFNLEVBQTFCOztBQUNBLFFBQUlJLFNBQVMsR0FBRzlGLGNBQUt5QixJQUFMLENBQVUsS0FBS3NFLE1BQWYsRUFBdUI1QixHQUF2QixFQUE0QixNQUE1QixDQUFoQjs7QUFDQXZELG9CQUFJQyxLQUFKLENBQVcsY0FBYWlGLFNBQVUsRUFBbEM7O0FBQ0EsUUFBSUUsU0FBUyxHQUFHaEcsY0FBS3lCLElBQUwsQ0FBVXFFLFNBQVYsRUFBcUJKLEtBQXJCLENBQWhCOztBQUNBOUUsb0JBQUlDLEtBQUosQ0FBVyxjQUFhbUYsU0FBVSxFQUFsQzs7QUFFQSxVQUFNcEUsa0JBQUdxRSxNQUFILENBQVVILFNBQVYsQ0FBTjtBQUVBLFVBQU1ILGNBQWMsQ0FBQ0csU0FBRCxDQUFwQjs7QUFDQWxGLG9CQUFJQyxLQUFKLENBQVUsWUFBVjs7QUFFQUQsb0JBQUlDLEtBQUosQ0FBVSxtQkFBVjs7QUFDQSxRQUFJO0FBQUNDLE1BQUFBO0FBQUQsUUFBVyxNQUFNLHdCQUFLaUUsT0FBTCxFQUFjLENBQUMsSUFBRCxFQUFPLFlBQVAsRUFBcUIsT0FBckIsRUFBOEJpQixTQUE5QixDQUFkLENBQXJCO0FBQ0FYLElBQUFBLFNBQVMsR0FBR0YsS0FBSyxDQUFDQyxJQUFOLENBQVd0RSxNQUFYLENBQVo7QUFDQXVFLElBQUFBLFNBQVMsR0FBR0EsU0FBUyxHQUFHQSxTQUFTLENBQUMsQ0FBRCxDQUFaLEdBQWtCLElBQXZDOztBQUNBekUsb0JBQUlDLEtBQUosQ0FBVyxrQkFBaUJ3RSxTQUFVLEVBQXRDOztBQUNBekUsb0JBQUlDLEtBQUosQ0FBVyxpQkFBZ0JtRSxZQUFhLEVBQXhDOztBQUNBLFFBQUlrQixlQUFlLEdBQUdiLFNBQVMsSUFBSUEsU0FBUyxLQUFLTCxZQUFqRDs7QUFDQXBFLG9CQUFJQyxLQUFKLENBQVcscUJBQW9CcUYsZUFBZ0IsRUFBL0M7O0FBR0EsUUFBSUEsZUFBSixFQUFxQjtBQUNuQlgsTUFBQUEsa0JBQWtCLEdBQUcsSUFBckI7QUFDQSxhQUFPLEtBQVA7QUFDRDtBQUNGLEdBOUJLLENBQU47QUErQkEsU0FBT0Esa0JBQVA7QUFDRCxDQXRDRDs7ZUF3Q2VoRixpQiIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCBfIGZyb20gJ2xvZGFzaCc7XG5pbXBvcnQgX2ZzIGZyb20gJ2ZzJztcbmltcG9ydCB7IGV4ZWMgfSBmcm9tICd0ZWVuX3Byb2Nlc3MnO1xuaW1wb3J0IHBhdGggZnJvbSAncGF0aCc7XG5pbXBvcnQgbG9nIGZyb20gJy4uL2xvZ2dlci5qcyc7XG5pbXBvcnQgeyB0ZW1wRGlyLCBzeXN0ZW0sIG1rZGlycCwgZnMsIHppcCB9IGZyb20gJ2FwcGl1bS1zdXBwb3J0JztcbmltcG9ydCB7XG4gIGdldEphdmFGb3JPcywgZ2V0QXBrc2lnbmVyRm9yT3MsIGdldEphdmFIb21lLFxuICByb290RGlyLCBBUEtTX0VYVEVOU0lPTiwgdW5zaWduQXBrLFxufSBmcm9tICcuLi9oZWxwZXJzLmpzJztcbmltcG9ydCB7IHF1b3RlIH0gZnJvbSAnc2hlbGwtcXVvdGUnO1xuXG5jb25zdCBERUZBVUxUX1BSSVZBVEVfS0VZID0gcGF0aC5yZXNvbHZlKHJvb3REaXIsICdrZXlzJywgJ3Rlc3RrZXkucGs4Jyk7XG5jb25zdCBERUZBVUxUX0NFUlRJRklDQVRFID0gcGF0aC5yZXNvbHZlKHJvb3REaXIsICdrZXlzJywgJ3Rlc3RrZXkueDUwOS5wZW0nKTtcbmNvbnN0IERFRkFVTFRfQ0VSVF9ESUdFU1QgPSAnYTQwZGE4MGE1OWQxNzBjYWE5NTBjZjE1YzE4YzQ1NGQ0N2EzOWIyNjk4OWQ4YjY0MGVjZDc0NWJhNzFiZjVkYyc7XG5jb25zdCBCVU5ETEVUT09MX1RVVE9SSUFMID0gJ2h0dHBzOi8vZGV2ZWxvcGVyLmFuZHJvaWQuY29tL3N0dWRpby9jb21tYW5kLWxpbmUvYnVuZGxldG9vbCc7XG5jb25zdCBBUEtTSUdORVJfVkVSSUZZX0ZBSUwgPSAnRE9FUyBOT1QgVkVSSUZZJztcblxubGV0IGFwa1NpZ25pbmdNZXRob2RzID0ge307XG5cbi8qKlxuICogRXhlY3V0ZSBhcGtzaWduZXIgdXRpbGl0eSB3aXRoIGdpdmVuIGFyZ3VtZW50cy5cbiAqXG4gKiBAcGFyYW0gez9BcnJheTxTdHJpbmc+fSBhcmdzIC0gVGhlIGxpc3Qgb2YgdG9vbCBhcmd1bWVudHMuXG4gKiBAcmV0dXJuIHtzdHJpbmd9IC0gQ29tbWFuZCBzdGRvdXRcbiAqIEB0aHJvd3Mge0Vycm9yfSBJZiBhcGtzaWduZXIgYmluYXJ5IGlzIG5vdCBwcmVzZW50IG9uIHRoZSBsb2NhbCBmaWxlIHN5c3RlbVxuICogICAgICAgICAgICAgICAgIG9yIHRoZSByZXR1cm4gY29kZSBpcyBub3QgZXF1YWwgdG8gemVyby5cbiAqL1xuYXBrU2lnbmluZ01ldGhvZHMuZXhlY3V0ZUFwa3NpZ25lciA9IGFzeW5jIGZ1bmN0aW9uIGV4ZWN1dGVBcGtzaWduZXIgKGFyZ3MgPSBbXSkge1xuICBjb25zdCBhcGtTaWduZXJKYXIgPSBhd2FpdCBnZXRBcGtzaWduZXJGb3JPcyh0aGlzKTtcbiAgY29uc3QgZnVsbENtZCA9IFtcbiAgICBhd2FpdCBnZXRKYXZhRm9yT3MoKSwgJy1YbXgxMDI0TScsICctWHNzMW0nLFxuICAgICctamFyJywgYXBrU2lnbmVySmFyLFxuICAgIC4uLmFyZ3NcbiAgXTtcbiAgbG9nLmRlYnVnKGBTdGFydGluZyBhcGtzaWduZXI6ICR7cXVvdGUoZnVsbENtZCl9YCk7XG4gIGNvbnN0IHtzdGRvdXQsIHN0ZGVycn0gPSBhd2FpdCBleGVjKGZ1bGxDbWRbMF0sIGZ1bGxDbWQuc2xpY2UoMSkpO1xuICBmb3IgKGxldCBbbmFtZSwgc3RyZWFtXSBvZiBbWydzdGRvdXQnLCBzdGRvdXRdLCBbJ3N0ZGVycicsIHN0ZGVycl1dKSB7XG4gICAgaWYgKCFfLnRyaW0oc3RyZWFtKSkge1xuICAgICAgY29udGludWU7XG4gICAgfVxuXG4gICAgaWYgKG5hbWUgPT09ICdzdGRvdXQnKSB7XG4gICAgICAvLyBNYWtlIHRoZSBvdXRwdXQgbGVzcyB0YWxrYXRpdmVcbiAgICAgIHN0cmVhbSA9IHN0cmVhbS5zcGxpdCgnXFxuJylcbiAgICAgICAgLmZpbHRlcigobGluZSkgPT4gIWxpbmUuaW5jbHVkZXMoJ1dBUk5JTkc6JykpXG4gICAgICAgIC5qb2luKCdcXG4nKTtcbiAgICB9XG4gICAgbG9nLmRlYnVnKGBhcGtzaWduZXIgJHtuYW1lfTogJHtzdHJlYW19YCk7XG4gIH1cbiAgcmV0dXJuIHN0ZG91dDtcbn07XG5cbi8qKlxuICogKFJlKXNpZ24gdGhlIGdpdmVuIGFwayBmaWxlIG9uIHRoZSBsb2NhbCBmaWxlIHN5c3RlbSB3aXRoIHRoZSBkZWZhdWx0IGNlcnRpZmljYXRlLlxuICpcbiAqIEBwYXJhbSB7c3RyaW5nfSBhcGsgLSBUaGUgZnVsbCBwYXRoIHRvIHRoZSBsb2NhbCBhcGsgZmlsZS5cbiAqIEB0aHJvd3Mge0Vycm9yfSBJZiBzaWduaW5nIGZhaWxzLlxuICovXG5hcGtTaWduaW5nTWV0aG9kcy5zaWduV2l0aERlZmF1bHRDZXJ0ID0gYXN5bmMgZnVuY3Rpb24gc2lnbldpdGhEZWZhdWx0Q2VydCAoYXBrKSB7XG4gIGxvZy5kZWJ1ZyhgU2lnbmluZyAnJHthcGt9JyB3aXRoIGRlZmF1bHQgY2VydGApO1xuICBpZiAoIShhd2FpdCBmcy5leGlzdHMoYXBrKSkpIHtcbiAgICB0aHJvdyBuZXcgRXJyb3IoYCR7YXBrfSBmaWxlIGRvZXNuJ3QgZXhpc3QuYCk7XG4gIH1cblxuICB0cnkge1xuICAgIGNvbnN0IGFyZ3MgPSBbJ3NpZ24nLFxuICAgICAgJy0ta2V5JywgREVGQVVMVF9QUklWQVRFX0tFWSxcbiAgICAgICctLWNlcnQnLCBERUZBVUxUX0NFUlRJRklDQVRFLFxuICAgICAgYXBrXTtcbiAgICBhd2FpdCB0aGlzLmV4ZWN1dGVBcGtzaWduZXIoYXJncyk7XG4gIH0gY2F0Y2ggKGVycikge1xuICAgIGxvZy53YXJuKGBDYW5ub3QgdXNlIGFwa3NpZ25lciB0b29sIGZvciBzaWduaW5nLiBEZWZhdWx0aW5nIHRvIHNpZ24uamFyLiBgICtcbiAgICAgIGBPcmlnaW5hbCBlcnJvcjogJHtlcnIuc3RkZXJyIHx8IGVyci5tZXNzYWdlfWApO1xuICAgIGNvbnN0IHNpZ25QYXRoID0gcGF0aC5yZXNvbHZlKHRoaXMuaGVscGVySmFyUGF0aCwgJ3NpZ24uamFyJyk7XG4gICAgY29uc3QgZnVsbENtZCA9IFthd2FpdCBnZXRKYXZhRm9yT3MoKSwgJy1qYXInLCBzaWduUGF0aCwgYXBrLCAnLS1vdmVycmlkZSddO1xuICAgIGxvZy5kZWJ1ZyhgU3RhcnRpbmcgc2lnbi5qYXI6ICR7cXVvdGUoZnVsbENtZCl9YCk7XG4gICAgdHJ5IHtcbiAgICAgIGF3YWl0IGV4ZWMoZnVsbENtZFswXSwgZnVsbENtZC5zbGljZSgxKSk7XG4gICAgfSBjYXRjaCAoZSkge1xuICAgICAgdGhyb3cgbmV3IEVycm9yKGBDb3VsZCBub3Qgc2lnbiB3aXRoIGRlZmF1bHQgY2VydGlmaWNhdGUuIGAgK1xuICAgICAgICBgT3JpZ2luYWwgZXJyb3IgJHtlLnN0ZGVyciB8fCBlLm1lc3NhZ2V9YCk7XG4gICAgfVxuICB9XG59O1xuXG4vKipcbiAqIChSZSlzaWduIHRoZSBnaXZlbiBhcGsgZmlsZSBvbiB0aGUgbG9jYWwgZmlsZSBzeXN0ZW0gd2l0aCBhIGN1c3RvbSBjZXJ0aWZpY2F0ZS5cbiAqXG4gKiBAcGFyYW0ge3N0cmluZ30gYXBrIC0gVGhlIGZ1bGwgcGF0aCB0byB0aGUgbG9jYWwgYXBrIGZpbGUuXG4gKiBAdGhyb3dzIHtFcnJvcn0gSWYgc2lnbmluZyBmYWlscy5cbiAqL1xuYXBrU2lnbmluZ01ldGhvZHMuc2lnbldpdGhDdXN0b21DZXJ0ID0gYXN5bmMgZnVuY3Rpb24gc2lnbldpdGhDdXN0b21DZXJ0IChhcGspIHtcbiAgbG9nLmRlYnVnKGBTaWduaW5nICcke2Fwa30nIHdpdGggY3VzdG9tIGNlcnRgKTtcbiAgaWYgKCEoYXdhaXQgZnMuZXhpc3RzKHRoaXMua2V5c3RvcmVQYXRoKSkpIHtcbiAgICB0aHJvdyBuZXcgRXJyb3IoYEtleXN0b3JlOiAke3RoaXMua2V5c3RvcmVQYXRofSBkb2Vzbid0IGV4aXN0LmApO1xuICB9XG4gIGlmICghKGF3YWl0IGZzLmV4aXN0cyhhcGspKSkge1xuICAgIHRocm93IG5ldyBFcnJvcihgJyR7YXBrfScgZG9lc24ndCBleGlzdC5gKTtcbiAgfVxuXG4gIHRyeSB7XG4gICAgYXdhaXQgdGhpcy5leGVjdXRlQXBrc2lnbmVyKFsnc2lnbicsXG4gICAgICAnLS1rcycsIHRoaXMua2V5c3RvcmVQYXRoLFxuICAgICAgJy0ta3Mta2V5LWFsaWFzJywgdGhpcy5rZXlBbGlhcyxcbiAgICAgICctLWtzLXBhc3MnLCBgcGFzczoke3RoaXMua2V5c3RvcmVQYXNzd29yZH1gLFxuICAgICAgJy0ta2V5LXBhc3MnLCBgcGFzczoke3RoaXMua2V5UGFzc3dvcmR9YCxcbiAgICAgIGFwa10pO1xuICB9IGNhdGNoIChlcnIpIHtcbiAgICBsb2cud2FybihgQ2Fubm90IHVzZSBhcGtzaWduZXIgdG9vbCBmb3Igc2lnbmluZy4gRGVmYXVsdGluZyB0byBqYXJzaWduZXIuIGAgK1xuICAgICAgYE9yaWdpbmFsIGVycm9yOiAke2Vyci5zdGRlcnIgfHwgZXJyLm1lc3NhZ2V9YCk7XG4gICAgdHJ5IHtcbiAgICAgIGlmIChhd2FpdCB1bnNpZ25BcGsoYXBrKSkge1xuICAgICAgICBsb2cuZGVidWcoYCcke2Fwa30nIGhhcyBiZWVuIHN1Y2Nlc3NmdWxseSB1bnNpZ25lZGApO1xuICAgICAgfSBlbHNlIHtcbiAgICAgICAgbG9nLmRlYnVnKGAnJHthcGt9JyBkb2VzIG5vdCBuZWVkIHRvIGJlIHVuc2lnbmVkYCk7XG4gICAgICB9XG4gICAgICBjb25zdCBqYXJzaWduZXIgPSBwYXRoLnJlc29sdmUoYXdhaXQgZ2V0SmF2YUhvbWUoKSwgJ2JpbicsXG4gICAgICAgIGBqYXJzaWduZXIke3N5c3RlbS5pc1dpbmRvd3MoKSA/ICcuZXhlJyA6ICcnfWApO1xuICAgICAgY29uc3QgZnVsbENtZCA9IFtqYXJzaWduZXIsXG4gICAgICAgICctc2lnYWxnJywgJ01ENXdpdGhSU0EnLFxuICAgICAgICAnLWRpZ2VzdGFsZycsICdTSEExJyxcbiAgICAgICAgJy1rZXlzdG9yZScsIHRoaXMua2V5c3RvcmVQYXRoLFxuICAgICAgICAnLXN0b3JlcGFzcycsIHRoaXMua2V5c3RvcmVQYXNzd29yZCxcbiAgICAgICAgJy1rZXlwYXNzJywgdGhpcy5rZXlQYXNzd29yZCxcbiAgICAgICAgYXBrLCB0aGlzLmtleUFsaWFzXTtcbiAgICAgIGxvZy5kZWJ1ZyhgU3RhcnRpbmcgamFyc2lnbmVyOiAke3F1b3RlKGZ1bGxDbWQpfWApO1xuICAgICAgYXdhaXQgZXhlYyhmdWxsQ21kWzBdLCBmdWxsQ21kLnNsaWNlKDEpKTtcbiAgICB9IGNhdGNoIChlKSB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoYENvdWxkIG5vdCBzaWduIHdpdGggY3VzdG9tIGNlcnRpZmljYXRlLiBgICtcbiAgICAgICAgYE9yaWdpbmFsIGVycm9yOiAke2Uuc3RkZXJyIHx8IGUubWVzc2FnZX1gKTtcbiAgICB9XG4gIH1cbn07XG5cbi8qKlxuICogKFJlKXNpZ24gdGhlIGdpdmVuIGFwayBmaWxlIG9uIHRoZSBsb2NhbCBmaWxlIHN5c3RlbSB3aXRoIGVpdGhlclxuICogY3VzdG9tIG9yIGRlZmF1bHQgY2VydGlmaWNhdGUgYmFzZWQgb24gX3RoaXMudXNlS2V5c3RvcmVfIHByb3BlcnR5IHZhbHVlXG4gKiBhbmQgWmlwLWFsaWducyBpdCBhZnRlciBzaWduaW5nLlxuICpcbiAqIEBwYXJhbSB7c3RyaW5nfSBhcHBQYXRoIC0gVGhlIGZ1bGwgcGF0aCB0byB0aGUgbG9jYWwgLmFwayhzKSBmaWxlLlxuICogQHRocm93cyB7RXJyb3J9IElmIHNpZ25pbmcgZmFpbHMuXG4gKi9cbmFwa1NpZ25pbmdNZXRob2RzLnNpZ24gPSBhc3luYyBmdW5jdGlvbiBzaWduIChhcHBQYXRoKSB7XG4gIGlmIChhcHBQYXRoLmVuZHNXaXRoKEFQS1NfRVhURU5TSU9OKSkge1xuICAgIGxldCBtZXNzYWdlID0gJ1NpZ25pbmcgb2YgLmFwa3MtZmlsZXMgaXMgbm90IHN1cHBvcnRlZC4gJztcbiAgICBpZiAodGhpcy51c2VLZXlzdG9yZSkge1xuICAgICAgbWVzc2FnZSArPSAnQ29uc2lkZXIgbWFudWFsIGFwcGxpY2F0aW9uIGJ1bmRsZSBzaWduaW5nIHdpdGggdGhlIGN1c3RvbSBrZXlzdG9yZSAnICtcbiAgICAgICAgYGxpa2UgaXQgaXMgZGVzY3JpYmVkIGF0ICR7QlVORExFVE9PTF9UVVRPUklBTH1gO1xuICAgIH0gZWxzZSB7XG4gICAgICBtZXNzYWdlICs9IGBDb25zaWRlciBtYW51YWwgYXBwbGljYXRpb24gYnVuZGxlIHNpZ25pbmcgd2l0aCB0aGUga2V5IGF0ICcke0RFRkFVTFRfUFJJVkFURV9LRVl9JyBgICtcbiAgICAgICAgYGFuZCB0aGUgY2VydGlmaWNhdGUgYXQgJyR7REVGQVVMVF9DRVJUSUZJQ0FURX0nLiBSZWFkICR7QlVORExFVE9PTF9UVVRPUklBTH0gZm9yIG1vcmUgZGV0YWlscy5gO1xuICAgIH1cbiAgICBsb2cud2FybihtZXNzYWdlKTtcbiAgICByZXR1cm47XG4gIH1cblxuICBsZXQgYXBrc2lnbmVyRm91bmQgPSB0cnVlO1xuICB0cnkge1xuICAgIGF3YWl0IGdldEFwa3NpZ25lckZvck9zKHRoaXMpO1xuICB9IGNhdGNoIChlcnIpIHtcbiAgICBhcGtzaWduZXJGb3VuZCA9IGZhbHNlO1xuICB9XG5cbiAgaWYgKGFwa3NpZ25lckZvdW5kKSB7XG4gICAgLy8gaXQgaXMgbmVjZXNzYXJ5IHRvIGFwcGx5IHppcGFsaWduIG9ubHkgYmVmb3JlIHNpZ25pbmdcbiAgICAvLyBpZiBhcGtzaWduZXIgaXMgdXNlZCBvciBvbmx5IGFmdGVyIHNpZ25pbmcgaWYgd2Ugb25seSBoYXZlXG4gICAgLy8gc2lnbi5qYXIgdXRpbGl0eVxuICAgIGF3YWl0IHRoaXMuemlwQWxpZ25BcGsoYXBwUGF0aCk7XG4gIH1cblxuICBpZiAodGhpcy51c2VLZXlzdG9yZSkge1xuICAgIGF3YWl0IHRoaXMuc2lnbldpdGhDdXN0b21DZXJ0KGFwcFBhdGgpO1xuICB9IGVsc2Uge1xuICAgIGF3YWl0IHRoaXMuc2lnbldpdGhEZWZhdWx0Q2VydChhcHBQYXRoKTtcbiAgfVxuXG4gIGlmICghYXBrc2lnbmVyRm91bmQpIHtcbiAgICBhd2FpdCB0aGlzLnppcEFsaWduQXBrKGFwcFBhdGgpO1xuICB9XG59O1xuXG4vKipcbiAqIFBlcmZvcm0gemlwLWFsaWduaW5nIHRvIHRoZSBnaXZlbiBsb2NhbCBhcGsgZmlsZS5cbiAqXG4gKiBAcGFyYW0ge3N0cmluZ30gYXBrIC0gVGhlIGZ1bGwgcGF0aCB0byB0aGUgbG9jYWwgYXBrIGZpbGUuXG4gKiBAcmV0dXJucyB7Ym9vbGVhbn0gVHJ1ZSBpZiB0aGUgYXBrIGhhcyBiZWVuIHN1Y2Nlc3NmdWxseSBhbGlnbmVkXG4gKiBvciBmYWxzZSBpZiB0aGUgYXBrIGhhcyBiZWVuIGFscmVhZHkgYWxpZ25lZC5cbiAqIEB0aHJvd3Mge0Vycm9yfSBJZiB6aXAtYWxpZ24gZmFpbHMuXG4gKi9cbmFwa1NpZ25pbmdNZXRob2RzLnppcEFsaWduQXBrID0gYXN5bmMgZnVuY3Rpb24gemlwQWxpZ25BcGsgKGFwaykge1xuICBhd2FpdCB0aGlzLmluaXRaaXBBbGlnbigpO1xuICB0cnkge1xuICAgIGF3YWl0IGV4ZWModGhpcy5iaW5hcmllcy56aXBhbGlnbiwgWyctYycsICc0JywgYXBrXSk7XG4gICAgbG9nLmRlYnVnKGAke2Fwa30nIGlzIGFscmVhZHkgemlwLWFsaWduZWQuIERvaW5nIG5vdGhpbmdgKTtcbiAgICByZXR1cm4gZmFsc2U7XG4gIH0gY2F0Y2ggKGUpIHtcbiAgICBsb2cuZGVidWcoYCcke2Fwa30nIGlzIG5vdCB6aXAtYWxpZ25lZC4gQWxpZ25pbmdgKTtcbiAgfVxuICB0cnkge1xuICAgIGF3YWl0IGZzLmFjY2VzcyhhcGssIF9mcy5XX09LKTtcbiAgfSBjYXRjaCAoZSkge1xuICAgIHRocm93IG5ldyBFcnJvcihgVGhlIGZpbGUgYXQgJyR7YXBrfScgaXMgbm90IHdyaXRlYWJsZS4gYCArXG4gICAgICBgUGxlYXNlIGdyYW50IHdyaXRlIHBlcm1pc3Npb25zIHRvIHRoaXMgZmlsZSBvciB0byBpdHMgcGFyZW50IGZvbGRlciAnJHtwYXRoLmRpcm5hbWUoYXBrKX0nIGAgK1xuICAgICAgYGZvciB0aGUgQXBwaXVtIHByb2Nlc3MsIHNvIGl0IGNhbiB6aXAtYWxpZ24gdGhlIGZpbGVgKTtcbiAgfVxuICBjb25zdCBhbGlnbmVkQXBrID0gYXdhaXQgdGVtcERpci5wYXRoKHtwcmVmaXg6ICdhcHBpdW0nLCBzdWZmaXg6ICcudG1wJ30pO1xuICBhd2FpdCBta2RpcnAocGF0aC5kaXJuYW1lKGFsaWduZWRBcGspKTtcbiAgdHJ5IHtcbiAgICBhd2FpdCBleGVjKHRoaXMuYmluYXJpZXMuemlwYWxpZ24sIFsnLWYnLCAnNCcsIGFwaywgYWxpZ25lZEFwa10pO1xuICAgIGF3YWl0IGZzLm12KGFsaWduZWRBcGssIGFwaywgeyBta2RpcnA6IHRydWUgfSk7XG4gICAgcmV0dXJuIHRydWU7XG4gIH0gY2F0Y2ggKGUpIHtcbiAgICBpZiAoYXdhaXQgZnMuZXhpc3RzKGFsaWduZWRBcGspKSB7XG4gICAgICBhd2FpdCBmcy51bmxpbmsoYWxpZ25lZEFwayk7XG4gICAgfVxuICAgIHRocm93IG5ldyBFcnJvcihgemlwQWxpZ25BcGsgZmFpbGVkLiBPcmlnaW5hbCBlcnJvcjogJHtlLnN0ZGVyciB8fCBlLm1lc3NhZ2V9YCk7XG4gIH1cbn07XG5cbi8qKlxuICogQHR5cGVkZWYge09iamVjdH0gQ2VydENoZWNrT3B0aW9uc1xuICogQHByb3BlcnR5IHtib29sZWFufSByZXF1aXJlRGVmYXVsdENlcnQgW3RydWVdIFdoZXRoZXIgdG8gcmVxdWlyZSB0aGF0IHRoZSBkZXN0aW5hdGlvbiBBUEtcbiAqIGlzIHNpZ25lZCB3aXRoIHRoZSBkZWZhdWx0IEFwcGl1bSBjZXJ0aWZpY2F0ZSBvciBhbnkgdmFsaWQgY2VydGlmaWNhdGUuIFRoaXMgb3B0aW9uXG4gKiBvbmx5IGhhcyBlZmZlY3QgaWYgYHVzZUtleXN0b3JlYCBwcm9wZXJ0eSBpcyB1bnNldC5cbiAqL1xuXG4vKipcbiAqIENoZWNrIGlmIHRoZSBhcHAgaXMgYWxyZWFkeSBzaWduZWQgd2l0aCB0aGUgZGVmYXVsdCBBcHBpdW0gY2VydGlmaWNhdGUuXG4gKlxuICogQHBhcmFtIHtzdHJpbmd9IGFwcFBhdGggLSBUaGUgZnVsbCBwYXRoIHRvIHRoZSBsb2NhbCAuYXBrKHMpIGZpbGUuXG4gKiBAcGFyYW0ge3N0cmluZ30gcGdrIC0gVGhlIG5hbWUgb2YgYXBwbGljYXRpb24gcGFja2FnZS5cbiAqIEBwYXJhbSB7Q2VydENoZWNrT3B0aW9uc30gb3B0cyAtIENlcnRpZmljYXRlIGNoZWNraW5nIG9wdGlvbnNcbiAqIEByZXR1cm4ge2Jvb2xlYW59IFRydWUgaWYgZ2l2ZW4gYXBwbGljYXRpb24gaXMgYWxyZWFkeSBzaWduZWQuXG4gKi9cbmFwa1NpZ25pbmdNZXRob2RzLmNoZWNrQXBrQ2VydCA9IGFzeW5jIGZ1bmN0aW9uIGNoZWNrQXBrQ2VydCAoYXBwUGF0aCwgcGtnLCBvcHRzID0ge30pIHtcbiAgbG9nLmRlYnVnKGBDaGVja2luZyBhcHAgY2VydCBmb3IgJHthcHBQYXRofWApO1xuICBpZiAoIWF3YWl0IGZzLmV4aXN0cyhhcHBQYXRoKSkge1xuICAgIGxvZy5kZWJ1ZyhgJyR7YXBwUGF0aH0nIGRvZXMgbm90IGV4aXN0YCk7XG4gICAgcmV0dXJuIGZhbHNlO1xuICB9XG5cbiAgaWYgKHRoaXMudXNlS2V5c3RvcmUpIHtcbiAgICByZXR1cm4gYXdhaXQgdGhpcy5jaGVja0N1c3RvbUFwa0NlcnQoYXBwUGF0aCwgcGtnKTtcbiAgfVxuXG4gIGlmIChwYXRoLmV4dG5hbWUoYXBwUGF0aCkgPT09IEFQS1NfRVhURU5TSU9OKSB7XG4gICAgYXBwUGF0aCA9IGF3YWl0IHRoaXMuZXh0cmFjdEJhc2VBcGsoYXBwUGF0aCk7XG4gIH1cblxuICBjb25zdCB7XG4gICAgcmVxdWlyZURlZmF1bHRDZXJ0ID0gdHJ1ZSxcbiAgfSA9IG9wdHM7XG4gIHRyeSB7XG4gICAgYXdhaXQgZ2V0QXBrc2lnbmVyRm9yT3ModGhpcyk7XG4gICAgY29uc3Qgb3V0cHV0ID0gYXdhaXQgdGhpcy5leGVjdXRlQXBrc2lnbmVyKFsndmVyaWZ5JywgJy0tcHJpbnQtY2VydHMnLCBhcHBQYXRoXSk7XG4gICAgaWYgKF8uaW5jbHVkZXMob3V0cHV0LCBERUZBVUxUX0NFUlRfRElHRVNUKSkge1xuICAgICAgbG9nLmRlYnVnKGAnJHthcHBQYXRofScgaXMgc2lnbmVkIHdpdGggdGhlIGRlZmF1bHQgY2VydGlmaWNhdGVgKTtcbiAgICB9IGVsc2Uge1xuICAgICAgbG9nLmRlYnVnKGAnJHthcHBQYXRofScgaXMgc2lnbmVkIHdpdGggYSBub24tZGVmYXVsdCBjZXJ0aWZpY2F0ZWApO1xuICAgIH1cbiAgICByZXR1cm4gIXJlcXVpcmVEZWZhdWx0Q2VydCB8fCBfLmluY2x1ZGVzKG91dHB1dCwgREVGQVVMVF9DRVJUX0RJR0VTVCk7XG4gIH0gY2F0Y2ggKGVycikge1xuICAgIC8vIGNoZWNrIGlmIHRoZXJlIGlzIG5vIHNpZ25hdHVyZVxuICAgIGlmIChfLmluY2x1ZGVzKGVyci5zdGRlcnIsIEFQS1NJR05FUl9WRVJJRllfRkFJTCkpIHtcbiAgICAgIGxvZy5kZWJ1ZyhgJyR7YXBwUGF0aH0nIGlzIG5vdCBzaWduZWRgKTtcbiAgICAgIHJldHVybiBmYWxzZTtcbiAgICB9XG4gICAgbG9nLndhcm4oYENhbm5vdCB1c2UgYXBrc2lnbmVyIHRvb2wgZm9yIHNpZ25hdHVyZSB2ZXJpZmljYXRpb24uIGAgK1xuICAgICAgYE9yaWdpbmFsIGVycm9yOiAke2Vyci5tZXNzYWdlfWApO1xuICB9XG5cbiAgbG9nLmRlYnVnKGBEZWZhdWx0aW5nIHRvIHZlcmlmeS5qYXJgKTtcbiAgdHJ5IHtcbiAgICBhd2FpdCBleGVjKGF3YWl0IGdldEphdmFGb3JPcygpLCBbXG4gICAgICAnLWphcicsIHBhdGgucmVzb2x2ZSh0aGlzLmhlbHBlckphclBhdGgsICd2ZXJpZnkuamFyJyksXG4gICAgICBhcHBQYXRoXG4gICAgXSk7XG4gICAgbG9nLmRlYnVnKGAnJHthcHBQYXRofScgaXMgc2lnbmVkIHdpdGggdGhlIGRlZmF1bHQgY2VydGlmaWNhdGVgKTtcbiAgICByZXR1cm4gdHJ1ZTtcbiAgfSBjYXRjaCAoZXJyKSB7XG4gICAgaWYgKCFyZXF1aXJlRGVmYXVsdENlcnQgJiYgXy5pbmNsdWRlcyhfLnRvTG93ZXIoZXJyLnN0ZGVyciksICdpbnZhbGlkIGNlcnQnKSkge1xuICAgICAgbG9nLmRlYnVnKGAnJHthcHBQYXRofScgaXMgc2lnbmVkIHdpdGggYSBub24tZGVmYXVsdCBjZXJ0aWZpY2F0ZWApO1xuICAgICAgcmV0dXJuIHRydWU7XG4gICAgfVxuICAgIGxvZy5kZWJ1ZyhgJyR7YXBwUGF0aH0nIGlzIG5vdCBzaWduZWQgd2l0aCB0aGUgZGVmYXVsdCBjZXJ0aWZpY2F0ZWApO1xuICAgIGxvZy5kZWJ1ZyhlcnIuc3RkZXJyID8gZXJyLnN0ZGVyciA6IGVyci5tZXNzYWdlKTtcbiAgICByZXR1cm4gZmFsc2U7XG4gIH1cbn07XG5cbi8qKlxuICogQ2hlY2sgaWYgdGhlIGFwcCBpcyBhbHJlYWR5IHNpZ25lZCB3aXRoIGEgY3VzdG9tIGNlcnRpZmljYXRlLlxuICpcbiAqIEBwYXJhbSB7c3RyaW5nfSBhcHBQYXRoIC0gVGhlIGZ1bGwgcGF0aCB0byB0aGUgbG9jYWwgYXBrKHMpIGZpbGUuXG4gKiBAcGFyYW0ge3N0cmluZ30gcGdrIC0gVGhlIG5hbWUgb2YgYXBwbGljYXRpb24gcGFja2FnZS5cbiAqIEByZXR1cm4ge2Jvb2xlYW59IFRydWUgaWYgZ2l2ZW4gYXBwbGljYXRpb24gaXMgYWxyZWFkeSBzaWduZWQgd2l0aCBhIGN1c3RvbSBjZXJ0aWZpY2F0ZS5cbiAqL1xuYXBrU2lnbmluZ01ldGhvZHMuY2hlY2tDdXN0b21BcGtDZXJ0ID0gYXN5bmMgZnVuY3Rpb24gY2hlY2tDdXN0b21BcGtDZXJ0IChhcHBQYXRoLCBwa2cpIHtcbiAgbG9nLmRlYnVnKGBDaGVja2luZyBjdXN0b20gYXBwIGNlcnQgZm9yICR7YXBwUGF0aH1gKTtcblxuICBpZiAocGF0aC5leHRuYW1lKGFwcFBhdGgpID09PSBBUEtTX0VYVEVOU0lPTikge1xuICAgIGFwcFBhdGggPSBhd2FpdCB0aGlzLmV4dHJhY3RCYXNlQXBrKGFwcFBhdGgpO1xuICB9XG5cbiAgbGV0IGggPSAnYS1mQS1GMC05JztcbiAgbGV0IG1kNVN0ciA9IFtgLipNRDUuKigoPzpbJHtofV17Mn06KXsxNX1bJHtofV17Mn0pYF07XG4gIGxldCBtZDUgPSBuZXcgUmVnRXhwKG1kNVN0ciwgJ21pJyk7XG4gIGxldCBrZXl0b29sID0gcGF0aC5yZXNvbHZlKGF3YWl0IGdldEphdmFIb21lKCksICdiaW4nLFxuICAgIGBrZXl0b29sJHtzeXN0ZW0uaXNXaW5kb3dzKCkgPyAnLmV4ZScgOiAnJ31gKTtcbiAgbGV0IGtleXN0b3JlSGFzaCA9IGF3YWl0IHRoaXMuZ2V0S2V5c3RvcmVNZDUoa2V5dG9vbCwgbWQ1KTtcbiAgcmV0dXJuIGF3YWl0IHRoaXMuY2hlY2tBcGtLZXlzdG9yZU1hdGNoKGtleXRvb2wsIG1kNSwga2V5c3RvcmVIYXNoLCBwa2csIGFwcFBhdGgpO1xufTtcblxuLyoqXG4gKiBHZXQgdGhlIE1ENSBoYXNoIG9mIHRoZSBrZXlzdG9yZS5cbiAqXG4gKiBAcGFyYW0ge3N0cmluZ30ga2V5dG9vbCAtIFRoZSBuYW1lIG9mIHRoZSBrZXl0b29sIHV0aWxpdHkuXG4gKiBAcGFyYW0ge1JlZ0V4cH0gbWQ1cmUgLSBUaGUgcGF0dGVybiB1c2VkIHRvIG1hdGNoIHRoZSByZXN1bHQgaW4gX2tleXRvb2xfIG91dHB1dC5cbiAqIEByZXR1cm4gez9zdHJpbmd9IEtleXN0b3JlIE1ENSBoYXNoIG9yIF9udWxsXyBpZiB0aGUgaGFzaCBjYW5ub3QgYmUgcGFyc2VkLlxuICogQHRocm93cyB7RXJyb3J9IElmIGdldHRpbmcga2V5c3RvcmUgTUQ1IGhhc2ggZmFpbHMuXG4gKi9cbmFwa1NpZ25pbmdNZXRob2RzLmdldEtleXN0b3JlTWQ1ID0gYXN5bmMgZnVuY3Rpb24gZ2V0S2V5c3RvcmVNZDUgKGtleXRvb2wsIG1kNXJlKSB7XG4gIGxvZy5kZWJ1ZygnUHJpbnRpbmcga2V5c3RvcmUgbWQ1LicpO1xuICB0cnkge1xuICAgIGxldCB7c3Rkb3V0fSA9IGF3YWl0IGV4ZWMoa2V5dG9vbCwgWyctdicsICctbGlzdCcsXG4gICAgICAnLWFsaWFzJywgdGhpcy5rZXlBbGlhcyxcbiAgICAgICcta2V5c3RvcmUnLCB0aGlzLmtleXN0b3JlUGF0aCxcbiAgICAgICctc3RvcmVwYXNzJywgdGhpcy5rZXlzdG9yZVBhc3N3b3JkXSk7XG4gICAgbGV0IGtleXN0b3JlSGFzaCA9IG1kNXJlLmV4ZWMoc3Rkb3V0KTtcbiAgICBrZXlzdG9yZUhhc2ggPSBrZXlzdG9yZUhhc2ggPyBrZXlzdG9yZUhhc2hbMV0gOiBudWxsO1xuICAgIGxvZy5kZWJ1ZyhgS2V5c3RvcmUgTUQ1OiAke2tleXN0b3JlSGFzaH1gKTtcbiAgICByZXR1cm4ga2V5c3RvcmVIYXNoO1xuICB9IGNhdGNoIChlKSB7XG4gICAgdGhyb3cgbmV3IEVycm9yKGBnZXRLZXlzdG9yZU1kNSBmYWlsZWQuIE9yaWdpbmFsIGVycm9yOiAke2UubWVzc2FnZX1gKTtcbiAgfVxufTtcblxuLyoqXG4gKiBDaGVjayBpZiB0aGUgTUQ1IGhhc2ggb2YgdGhlIHBhcnRpY3VsYXIgYXBwbGljYXRpb24gbWF0Y2hlcyB0byB0aGUgZ2l2ZW4gaGFzaC5cbiAqXG4gKiBAcGFyYW0ge3N0cmluZ30ga2V5dG9vbCAtIFRoZSBuYW1lIG9mIHRoZSBrZXl0b29sIHV0aWxpdHkuXG4gKiBAcGFyYW0ge1JlZ0V4cH0gbWQ1cmUgLSBUaGUgcGF0dGVybiB1c2VkIHRvIG1hdGNoIHRoZSByZXN1bHQgaW4gX2tleXRvb2xfIG91dHB1dC5cbiAqIEBwYXJhbSB7c3RyaW5nfSBrZXlzdG9yZUhhc2ggLSBUaGUgZXhwZWN0ZWQgaGFzaCB2YWx1ZS5cbiAqIEBwYXJhbSB7c3RyaW5nfSBwa2cgLSBUaGUgbmFtZSBvZiB0aGUgaW5zdGFsbGVkIHBhY2thZ2UuXG4gKiBAcGFyYW0ge3N0cmluZ30gYXBrIC0gVGhlIGZ1bGwgcGF0aCB0byB0aGUgZXhpc3RpbmcgYXBrIGZpbGUuXG4gKiBAcmV0dXJuIHtib29sZWFufSBUcnVlIGlmIGJvdGggaGFzaGVzIGFyZSBlcXVhbC5cbiAqIEB0aHJvd3Mge0Vycm9yfSBJZiBnZXR0aW5nIGtleXN0b3JlIE1ENSBoYXNoIGZhaWxzLlxuICovXG5hcGtTaWduaW5nTWV0aG9kcy5jaGVja0Fwa0tleXN0b3JlTWF0Y2ggPSBhc3luYyBmdW5jdGlvbiBjaGVja0Fwa0tleXN0b3JlTWF0Y2ggKGtleXRvb2wsIG1kNXJlLCBrZXlzdG9yZUhhc2gsIHBrZywgYXBrKSB7XG4gIGxldCBlbnRyeUhhc2ggPSBudWxsO1xuICBsZXQgcnNhID0gL15NRVRBLUlORlxcLy4qXFwuW3JSXVtzU11bYUFdJC87XG4gIGxldCBmb3VuZEtleXN0b3JlTWF0Y2ggPSBmYWxzZTtcblxuICAvL2ZvciAobGV0IGVudHJ5IG9mIGVudHJpZXMpIHtcbiAgYXdhaXQgemlwLnJlYWRFbnRyaWVzKGFwaywgYXN5bmMgKHtlbnRyeSwgZXh0cmFjdEVudHJ5VG99KSA9PiB7XG4gICAgZW50cnkgPSBlbnRyeS5maWxlTmFtZTtcbiAgICBpZiAoIXJzYS50ZXN0KGVudHJ5KSkge1xuICAgICAgcmV0dXJuO1xuICAgIH1cbiAgICBsb2cuZGVidWcoYEVudHJ5OiAke2VudHJ5fWApO1xuICAgIGxldCBlbnRyeVBhdGggPSBwYXRoLmpvaW4odGhpcy50bXBEaXIsIHBrZywgJ2NlcnQnKTtcbiAgICBsb2cuZGVidWcoYGVudHJ5UGF0aDogJHtlbnRyeVBhdGh9YCk7XG4gICAgbGV0IGVudHJ5RmlsZSA9IHBhdGguam9pbihlbnRyeVBhdGgsIGVudHJ5KTtcbiAgICBsb2cuZGVidWcoYGVudHJ5RmlsZTogJHtlbnRyeUZpbGV9YCk7XG4gICAgLy8gZW5zdXJlIC90bXAvcGtnL2NlcnQvIGRvZXNuJ3QgZXhpc3Qgb3IgZXh0cmFjdCB3aWxsIGZhaWwuXG4gICAgYXdhaXQgZnMucmltcmFmKGVudHJ5UGF0aCk7XG4gICAgLy8gTUVUQS1JTkYvQ0VSVC5SU0FcbiAgICBhd2FpdCBleHRyYWN0RW50cnlUbyhlbnRyeVBhdGgpO1xuICAgIGxvZy5kZWJ1ZygnZXh0cmFjdGVkIScpO1xuICAgIC8vIGNoZWNrIGZvciBtYXRjaFxuICAgIGxvZy5kZWJ1ZygnUHJpbnRpbmcgYXBrIG1kNS4nKTtcbiAgICBsZXQge3N0ZG91dH0gPSBhd2FpdCBleGVjKGtleXRvb2wsIFsnLXYnLCAnLXByaW50Y2VydCcsICctZmlsZScsIGVudHJ5RmlsZV0pO1xuICAgIGVudHJ5SGFzaCA9IG1kNXJlLmV4ZWMoc3Rkb3V0KTtcbiAgICBlbnRyeUhhc2ggPSBlbnRyeUhhc2ggPyBlbnRyeUhhc2hbMV0gOiBudWxsO1xuICAgIGxvZy5kZWJ1ZyhgZW50cnlIYXNoIE1ENTogJHtlbnRyeUhhc2h9YCk7XG4gICAgbG9nLmRlYnVnKGBrZXlzdG9yZSBNRDU6ICR7a2V5c3RvcmVIYXNofWApO1xuICAgIGxldCBtYXRjaGVzS2V5c3RvcmUgPSBlbnRyeUhhc2ggJiYgZW50cnlIYXNoID09PSBrZXlzdG9yZUhhc2g7XG4gICAgbG9nLmRlYnVnKGBNYXRjaGVzIGtleXN0b3JlPyAke21hdGNoZXNLZXlzdG9yZX1gKTtcblxuICAgIC8vIElmIHdlIGhhdmUgYSBrZXlzdG9yZSBtYXRjaCwgc3RvcCBpdGVyYXRpbmdcbiAgICBpZiAobWF0Y2hlc0tleXN0b3JlKSB7XG4gICAgICBmb3VuZEtleXN0b3JlTWF0Y2ggPSB0cnVlO1xuICAgICAgcmV0dXJuIGZhbHNlO1xuICAgIH1cbiAgfSk7XG4gIHJldHVybiBmb3VuZEtleXN0b3JlTWF0Y2g7XG59O1xuXG5leHBvcnQgZGVmYXVsdCBhcGtTaWduaW5nTWV0aG9kcztcbiJdLCJmaWxlIjoibGliL3Rvb2xzL2Fway1zaWduaW5nLmpzIiwic291cmNlUm9vdCI6Ii4uLy4uLy4uIn0=
